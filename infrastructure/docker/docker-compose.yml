# SDLC Agent Squad - Local Development Stack
version: '3.8'

services:
  # LocalStack for AWS service emulation
  localstack:
    image: localstack/localstack:3.0
    container_name: sdlc-localstack
    ports:
      - "4566:4566"            # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - DEBUG=${DEBUG:-0}
      - SERVICES=lambda,dynamodb,apigateway,s3,sqs
      - DOCKER_HOST=unix:///var/run/docker.sock
      - LAMBDA_EXECUTOR=docker
      - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - "${TMPDIR:-/tmp}/localstack:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "../localstack/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SDLC Agent Squad webhook server
  agent-squad:
    build:
      context: ../../agent_squad_sdlc
      dockerfile: ../infrastructure/docker/Dockerfile
    container_name: sdlc-agent-squad
    ports:
      - "8080:8080"
    environment:
      # Application settings
      - ENVIRONMENT=local
      - DEBUG=true
      - STORAGE_TYPE=memory
      - HOST=0.0.0.0
      - PORT=8080

      # Anthropic API (required - provide via .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL_ID=${CLAUDE_MODEL_ID:-claude-sonnet-4-20250514}

      # GitHub App (required - provide via .env file)
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_APP_PRIVATE_KEY=${GITHUB_APP_PRIVATE_KEY}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
      - GITHUB_OWNER=${GITHUB_OWNER}
      - GITHUB_REPO=${GITHUB_REPO}

      # AWS / LocalStack settings
      - AWS_REGION=us-east-1
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      # Mount source for development (hot reload)
      - "../../agent_squad_sdlc:/app/agent_squad_sdlc:ro"

  # ngrok for webhook tunneling (optional)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: sdlc-ngrok
    profiles:
      - tunnel
    command: http agent-squad:8080 --log stdout
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN:-}
    ports:
      - "4040:4040"  # ngrok web interface
    depends_on:
      - agent-squad

volumes:
  localstack_data:

networks:
  default:
    name: sdlc-network
